<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dealerships - Car Dealership</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        nav {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        nav .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        nav ul {
            list-style: none;
            display: flex;
            gap: 2rem;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .user-info {
            color: white;
            font-weight: 600;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }
        
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .filter-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #333;
        }
        
        .filter-group select, .filter-group input {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .filter-group button {
            padding: 0.5rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .filter-group button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .dealers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }
        
        .dealer-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease;
        }
        
        .dealer-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .dealer-card h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }
        
        .dealer-info {
            margin-bottom: 0.5rem;
            color: #666;
        }
        
        .dealer-info strong {
            color: #333;
        }
        
        .cars-list {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #f0f0f0;
        }
        
        .cars-list h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .car-tag {
            display: inline-block;
            background: #e8eaf6;
            color: #667eea;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            margin: 0.3rem;
            font-size: 0.9rem;
        }
        
        .dealer-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .login-prompt {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .login-prompt h2 {
            color: #333;
            margin-bottom: 1rem;
        }
        
        .login-prompt p {
            color: #666;
            margin-bottom: 2rem;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: white;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/dealerships/">Dealerships</a></li>
                <li><a href="/about/">About</a></li>
                <li><a href="/contact/">Contact</a></li>
            </ul>
            <div class="user-info">
                <span id="userDisplay">Loading...</span>
                <a href="/djangoapp/logout" style="margin-left: 1rem;">Logout</a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <h1>Our Dealerships</h1>
        
        <div id="loginPrompt" class="login-prompt" style="display: none;">
            <h2>ðŸ”’ Login Required</h2>
            <p>Please login to view our dealership locations and inventory.</p>
            <a href="/login/" class="btn btn-primary">Login / Register</a>
        </div>
        
        <div id="dealerContent" style="display: none;">
            <div class="filters">
                <div class="filter-group">
                    <label>Filter by State:</label>
                    <select id="stateFilter" onchange="filterDealers()">
                        <option value="">All States</option>
                    </select>
                    
                    <label style="margin-left: 2rem;">Search:</label>
                    <input type="text" id="searchInput" placeholder="Search dealers or cars..." onkeyup="filterDealers()">
                    
                    <button onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>
            
            <div id="dealersGrid" class="dealers-grid">
                <div class="loading">Loading dealerships...</div>
            </div>
        </div>
    </div>
    
    <script>
        let allDealers = [];
        let currentUser = null;
        
        async function checkAuth() {
            try {
                // Check if user is authenticated
                const userResponse = await fetch('/djangoapp/get_user', {
                    credentials: 'include'  // Include cookies for session
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    
                    if (userData.isAuthenticated) {
                        currentUser = userData.userName || 'User';
                        document.getElementById('userDisplay').textContent = `Welcome, ${currentUser}!`;
                        document.getElementById('loginPrompt').style.display = 'none';
                        document.getElementById('dealerContent').style.display = 'block';
                        loadDealers();
                    } else {
                        showLoginPrompt();
                    }
                } else {
                    showLoginPrompt();
                }
            } catch (error) {
                showLoginPrompt();
            }
        }
        
        function showLoginPrompt() {
            document.getElementById('userDisplay').textContent = 'Not logged in';
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('dealerContent').style.display = 'none';
        }
        
        async function loadDealers() {
            try {
                const response = await fetch('/djangoapp/get_dealers', {
                    credentials: 'include'  // Include cookies for session
                });
                allDealers = await response.json();
                
                // Populate state filter
                const states = [...new Set(allDealers.map(d => d.state))];
                const stateFilter = document.getElementById('stateFilter');
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateFilter.appendChild(option);
                });
                
                displayDealers(allDealers);
            } catch (error) {
                document.getElementById('dealersGrid').innerHTML = '<div class="loading">Error loading dealerships</div>';
            }
        }
        
        function displayDealers(dealers) {
            const grid = document.getElementById('dealersGrid');
            
            if (dealers.length === 0) {
                grid.innerHTML = '<div class="loading">No dealerships found</div>';
                return;
            }
            
            grid.innerHTML = dealers.map(dealer => `
                <div class="dealer-card">
                    <h3>${dealer.name}</h3>
                    <div class="dealer-info"><strong>Location:</strong> ${dealer.city}, ${dealer.state}</div>
                    <div class="dealer-info"><strong>Address:</strong> ${dealer.address}</div>
                    <div class="dealer-info"><strong>ZIP:</strong> ${dealer.zip}</div>
                    
                    ${dealer.cars ? `
                        <div class="cars-list">
                            <h4>Available Vehicles:</h4>
                            ${dealer.cars.map(car => `<span class="car-tag">${car}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="dealer-actions">
                        <a href="/dealer/${dealer.id}/" class="btn btn-primary">View Details</a>
                        <a href="/dealer/${dealer.id}/review/" class="btn btn-secondary">Write Review</a>
                    </div>
                </div>
            `).join('');
        }
        
        function filterDealers() {
            const stateFilter = document.getElementById('stateFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = allDealers;
            
            if (stateFilter) {
                filtered = filtered.filter(d => d.state === stateFilter);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(d => 
                    d.name.toLowerCase().includes(searchTerm) ||
                    d.city.toLowerCase().includes(searchTerm) ||
                    (d.cars && d.cars.some(car => car.toLowerCase().includes(searchTerm)))
                );
            }
            
            displayDealers(filtered);
        }
        
        function clearFilters() {
            document.getElementById('stateFilter').value = '';
            document.getElementById('searchInput').value = '';
            displayDealers(allDealers);
        }
        
        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>
